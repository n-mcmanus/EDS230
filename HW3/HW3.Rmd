---
title: "HW3: Almond Profit and Informal Sensitivity Analysis"
author: "Katheryn Moya & Nick McManus"
date: "4/27/2023"
output: 
 html_document: 
    toc: yes
    toc_float: yes
    theme: cerulean
    code_folding: hide
    smooth_scroll: yes
    collapsed: yes
---

```{r setup, include=T, warning=F, message=F}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)

library(tidyverse)
library(here)
library(purrr)
library(ggpubr)
```


## Read in and wrangle climate data

First we'll read in our `clim.txt` data file, which provides daily precipitation as well as minimum and maximum temperatures. Next, we'll create a data subset with the total precipitation and absolute minimum and maximum temperatures for each month. Then, we'll form two subsets for use in the almond yield function: one with minimum February temperatures and another with the total January precipitation.
```{r}
### Read in data
clim_df <- read_table("clim.txt") %>% 
  ## remove quotes in names
  janitor::clean_names()


### Find the absolute tmin and tmax and summed precip
clim_months <- clim_df %>% 
  group_by(month, year) %>% 
  summarize(tmax_max = max(tmax_c),
            tmin_min = min(tmin_c),
            precip_sum = sum(precip))


### Filter for Feb Tmin
tmin_feb <- clim_months %>% 
  filter(month ==2) %>% 
  ungroup() %>% 
  select(year, tmin_min)

### Filter for Jan precip
precip_jan <- clim_months %>% 
  filter(month == 1) %>% 
  ungroup() %>% 
  select(year, precip_sum)
```



# Sensitivity Analysis

We'll perform the sensitivity analysis using outputs from the almond yield function. This function outputs the yield anomaly and profit for each year within the time series. 

```{r}
### Read in function
source(here("R/almond_yield_profit.R"))
```


##  Generate samples

For this analysis, we're testing for the uncertainties surrounding the `tcoeff1` parameter -- which affects almond yield anomaly -- as well as the price per ton/acre (`price_ton`) for almonds. The informal sensitivity analysis for the `tcoeff1` parameter includes the following assumptions:

* Default value of the parameter is -0.015
* Uncertainty of  $\pm$20% for parameter
* Uniform distribution since we do not know anything about variation

For the price per ton/acre of almonds, the following assumptions were made to randomly generate samples:
* Default (mean) price is $3520/ton/acre
* Due to market changes, one standard deviation in price is $200/ton/acre
* Changes in price follow normal distribution

```{r}
nsamples = 300

### tcoeff1 sample
dev = 0.2
tcoeff1_base = -0.015

tcoeff1 <- runif(min = tcoeff1_base + tcoeff1_base*dev,
                        max = tcoeff1_base - tcoeff1_base*dev,
                        n = nsamples)

### price samples
price_ton <- rnorm(mean = 3520, sd = 200, n = nsamples)


### bind samples together in one df
params <- cbind.data.frame(tcoeff1, price_ton)
```


## Run function with `purrr::pmap()`

Using `pmap()`, we can easily run our almond yield function across our entire sample of parameter values (300 times!). The resulting df `yield_profit` contains the mean yield and mean profit generated over the entire time series given a specific value for `tcoeff1` and `price_ton`. 
```{r}
### run with pmap
results <- params %>% pmap(almond_yield_profit, 
                           tmin = tmin_feb$tmin_min,
                           precip = precip_jan$precip_sum)

### View head of results and make sure length = 300
# results[[1]]
# length(results)

### Extract results from list into df
yield_profit <- map_df(results, `[`, c("mean_yield", "mean_profit"))

### Bind results to the input parameter values
yield_profit <- cbind.data.frame(yield_profit, params)

```



## Visualize results
Here we will make the "meaningful" figures
