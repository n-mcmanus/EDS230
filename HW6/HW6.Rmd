---
title: 'HW6: Forest Size Sensitivity using Sobol and ODE'
author: "Nick McManus & Katheryn Moya"
date: "2023-05-19"
output: 
 html_document: 
    toc: yes
    toc_float: yes
    theme: cerulean
    code_folding: show
    smooth_scroll: yes
    collapsed: yes
---

```{r setup, include=FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(sensitivity)  ## Sobol
library(deSolve)      ## ode solver
library(kableExtra)   ## nice tables
library(tidyverse)
library(here)
```


```{r}
### read in function
source(here("R/forest_growth.R"))
```


## ODE solver w/o sensitivity

First we'll run the model (using the ODE solver) to determine the forest size after 300 years and visualize the results. For this run, we'll make the following assumptions:
-   initial forest size (Cinnitial) of 10 kgC
-   canopy closure threshold (closure) of 50 kgC
-   carrying capacity (K) of 250 kgC
-   growth rate before canopy closure (r) of 0.01
-   growth rate after canopy closure (g) of 2 kg/yr

```{r}
## set initial forest size
Cinitial = 10

## set parameter values then bind as df
k = 250
r = 0.01
g = 2
closure = 50

params = cbind.data.frame(k, r, g, closure)


## sequence of times for 300 years
simtime = seq(from = 1, to = 300)


## Run ODE solver and save results as df
result = ode(y = Cinitial, times = simtime, func = forest_growth, parms = params)
colnames(result) = c("time", "C")
result = as.data.frame(result)
```


```{r}
## Visualize results
ggplot(result, aes(x = time, y = C)) + 
  geom_line(size = 0.8, color = "forestgreen")+
  labs(x = "Years passed",
       y = "Forest size (kg C)") +
  scale_x_continuous(limits = c(0, 300), breaks = seq(0, 300, by=50), expand = c(0,0))+
  scale_y_continuous(limits = c(0, 200), expand = c(0,0)) +
  theme_classic() +
  theme(
    axis.title.x = element_text(size = 10, face = 'bold', vjust = -0.5),
    axis.title.y = element_text(size = 10, face = 'bold', vjust = 2)
  )
```

**Figure 1.** Caption here



## Sobol global

Now we'll perform a sensitivity analysis that explores how the estimated maximum forest size (max C over 300 years) varies with changes to three parameters: r, g, and K. 
-   We'll assume normal distribution with standard deviation of 10%

First, create a sample of parameter values using sobol.
```{r}
## all will have standard dev of 10%
sd = 0.1
## we'll make 1000 for each
nsample = 1000


## create two samples of parameter values
r_sobol = rnorm(mean = r, sd = r*sd, n = nsample)
g_sobol = rnorm(mean = g, sd = g*sd, n = nsample)
k_sobol = rnorm(mean = k, sd = k*sd, n = nsample)
param1 = cbind.data.frame(r = r_sobol, g = g_sobol, k = k_sobol)

r_sobol = rnorm(mean = r, sd = r*sd, n = nsample)
g_sobol = rnorm(mean = g, sd = g*sd, n = nsample)
k_sobol = rnorm(mean = k, sd = k*sd, n = nsample)
param2 = cbind.data.frame(r = r_sobol, g = g_sobol, k = k_sobol)

## fix in case you get negatives
param1 = param1 %>% map_df(pmax, 0)
param2 = param2 %>% map_df(pmax, 0)

## get sobol object from parameter sets
sens_c = sobolSalt(model = NULL, X1 = param1, X2 = param2, nboot = 300)

## view outputs
# head(sens_c$X)

## rename columns
colnames(sens_c$X) = c("r", "g", "k")
```


Now we'll create a wrapper function so that we can use `map()` to run the ODE solver and find the maximum forest size for each set of parameters. The one parameter we are not changing is the canopy closure threshold, which remains 50 kgC as before. 
```{r}
## create wrapper fxn to run ODE and return max forest size
c_wrapper = function(r, g, k, closure, Cinitial, times, func) {
    ## turn params into list for ODE solver
    params = list(r=r, g=g, k=k, closure=closure)
    result = ode(y=Cinitial, times=times, func=func, parms=params)
    ## rename columns and turn into df
    colnames(result)=c("time","C")
    result = as.data.frame(result)
    
    ## get max forest size
    max_c = max(result$C)
  return(list(max_c = max_c))
}


## now use pmap to run our c_wrapper fxn over 
## a vector of parameter values from our sobol output
allresults = as.data.frame(sens_c$X) %>% 
  pmap(c_wrapper, closure = closure, Cinitial = Cinitial, 
       times = simtime, func = forest_growth)

## extract values from bad list format
allres = allresults %>% map_dfr(`[`,"max_c")
```

```{r}
### Now visualize the sensitivity results!

## pivot df so that you can adjust width box plot lol
tmp = allres %>% 
  gather(key = "metric", value = "value")

## create the boxplot
ggplot(data = tmp, aes(x = metric, y = value)) +
  geom_boxplot(fill = "#7E8F13", color = "#3E5409",
               alpha = 0.4, size = 0.7, width = 0.4) +
  labs(y = "Maximum forest size (kgC)",
       x = element_blank())+
  theme_minimal() +
  theme(
    axis.title.y = element_text(vjust = 3, face = 'bold'),
    axis.ticks.x = element_blank(),
    axis.text.x = element_blank()
  )

```

**Figure 2.** Caption here

```{r}
## sobol indices
sens_forest = sensitivity::tell(sens_c, allres$max_c)

## put indices in "tidy" format for tables
sens_T <- as.data.frame(sens_forest$T)
row.names(sens_T) <- NULL
sens_T <- add_column(.data = sens_T, parameters = c("r", "g", "k"), .before = 1)

sens_S <- as.data.frame(sens_forest$S)
row.names(sens_S) <- NULL
sens_S <- add_column(.data = sens_S, parameter = c("r", "g", "k"), .before = 1)


## put in nice tables
sens_T %>% 
  kable(caption = "**Table 1.** First order sobol indices") %>% 
  kable_styling(full_width = FALSE,
                bootstrap_options = "hover",
                position = "left")

sens_S %>% 
  kable(caption = "**Table 2.** Total sobol indices") %>% 
  kable_styling(full_width = FALSE,
                bootstrap_options = "hover",
                position = "left")
```













